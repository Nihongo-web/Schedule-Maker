<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Scheduler v2.0 | Mobile Optimized</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg); 
            color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Hide scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            .mobile-grid { grid-template-columns: 1fr; }
            .sidebar-collapsed { transform: translateX(-100%); }
        }

        /* Animation for smooth transitions */
        .tab-active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row overflow-hidden">

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

    <aside id="sidebar" class="fixed md:relative w-72 glass h-screen transition-transform duration-300 z-50 sidebar-collapsed md:transform-none flex flex-col">
        <div class="p-6 flex items-center justify-between border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-600 rounded-lg"><i data-lucide="calendar" class="text-white"></i></div>
                <h1 class="font-bold text-lg tracking-tight">PRO SCHEDULER</h1>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden p-2"><i data-lucide="x"></i></button>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-1 no-scrollbar">
            <button onclick="switchTab('dashboard')" class="nav-btn active w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-indigo-600/20 transition group">
                <i data-lucide="layout-grid" class="w-5 h-5 group-hover:text-indigo-400"></i> Editor Jadwal
            </button>
            <button onclick="switchTab('master-guru')" class="nav-btn w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-indigo-600/20 transition group">
                <i data-lucide="users" class="w-5 h-5 group-hover:text-indigo-400"></i> Database Guru
            </button>
            <button onclick="switchTab('master-mapel')" class="nav-btn w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-indigo-600/20 transition group">
                <i data-lucide="book-open" class="w-5 h-5 group-hover:text-indigo-400"></i> Mata Pelajaran
            </button>
            <button onclick="switchTab('master-kelas')" class="nav-btn w-full flex items-center gap-3 p-3.5 rounded-xl hover:bg-indigo-600/20 transition group">
                <i data-lucide="school" class="w-5 h-5 group-hover:text-indigo-400"></i> Daftar Kelas
            </button>
            
            <div class="pt-6 mt-6 border-t border-slate-700/50 space-y-2">
                <p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-widest">Aksi</p>
                <button onclick="exportPDF()" class="w-full flex items-center gap-3 p-3.5 text-slate-300 hover:bg-red-500/10 hover:text-red-400 rounded-xl transition">
                    <i data-lucide="file-down"></i> Export PDF
                </button>
                <button onclick="exportExcel()" class="w-full flex items-center gap-3 p-3.5 text-slate-300 hover:bg-emerald-500/10 hover:text-emerald-400 rounded-xl transition">
                    <i data-lucide="table"></i> Export Excel
                </button>
            </div>
        </nav>
    </aside>

    <main class="flex-1 h-screen flex flex-col overflow-hidden relative">
        
        <header class="md:hidden glass p-4 flex items-center justify-between shrink-0">
            <button onclick="toggleSidebar()" class="p-2"><i data-lucide="menu"></i></button>
            <h2 class="font-bold text-sm">PRO SCHEDULER</h2>
            <div id="mobile-class-indicator" class="text-[10px] bg-indigo-600 px-2 py-1 rounded-full uppercase font-bold">Pilih Kelas</div>
        </header>

        <div class="p-4 md:p-8 shrink-0 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h2 id="tab-title" class="text-2xl md:text-3xl font-bold text-white">Editor Jadwal</h2>
                <p class="text-slate-400 text-sm md:text-base">Kelola jadwal kelas dengan presisi manual.</p>
            </div>
            
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-2 md:pb-0">
                <select id="select-kelas-active" onchange="changeActiveKelas()" class="bg-slate-800 border border-slate-700 p-2.5 rounded-xl text-sm focus:ring-2 ring-indigo-500 outline-none min-w-[140px]">
                    </select>
                <button onclick="openTimeSlotModal()" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 hover:bg-slate-700"><i data-lucide="settings-2" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div id="mobile-day-nav" class="flex md:hidden border-b border-slate-800 bg-slate-900/50 shrink-0 overflow-x-auto no-scrollbar">
            </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar pb-24">
            
            <section id="content-dashboard" class="tab-content block">
                <div id="schedule-container" class="grid gap-4">
                    </div>
            </section>

            <section id="content-master-guru" class="tab-content hidden space-y-6">
                <div class="glass p-6 rounded-2xl max-w-xl">
                    <h3 class="font-bold mb-4">Input Data Guru</h3>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="input-guru-nama" placeholder="Nama Lengkap" class="bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none">
                        <div class="flex gap-3">
                            <input type="text" id="input-guru-inisial" placeholder="Kode/Inisial" class="flex-1 bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none uppercase">
                            <button onclick="addGuru()" class="bg-indigo-600 px-8 rounded-xl font-bold">Simpan</button>
                        </div>
                    </div>
                </div>
                <div id="list-guru" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </section>

            <section id="content-master-mapel" class="tab-content hidden space-y-6">
                <div class="glass p-6 rounded-2xl max-w-xl">
                    <h3 class="font-bold mb-4">Input Mata Pelajaran</h3>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="input-mapel-nama" placeholder="Nama Pelajaran" class="bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none">
                        <div class="flex items-center gap-3">
                            <label class="text-sm text-slate-400">Warna Label:</label>
                            <input type="color" id="input-mapel-color" value="#6366f1" class="w-12 h-12 bg-transparent border-none cursor-pointer">
                            <button onclick="addMapel()" class="flex-1 bg-indigo-600 py-3 rounded-xl font-bold">Tambah Mapel</button>
                        </div>
                    </div>
                </div>
                <div id="list-mapel" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </section>

            <section id="content-master-kelas" class="tab-content hidden space-y-6">
                <div class="glass p-6 rounded-2xl max-w-xl">
                    <h3 class="font-bold mb-4">Kelola Kelas</h3>
                    <div class="flex gap-3">
                        <input type="text" id="input-kelas-nama" placeholder="Contoh: XII-IPA-1" class="flex-1 bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none">
                        <button onclick="addKelas()" class="bg-indigo-600 px-6 rounded-xl font-bold">Tambah</button>
                    </div>
                </div>
                <div id="list-kelas" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
            </section>
        </div>
    </main>

    <div id="modal-assign" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden flex-col justify-end md:justify-center p-0 md:p-4">
        <div class="glass w-full max-w-lg mx-auto rounded-t-[32px] md:rounded-[32px] p-8 shadow-2xl transform translate-y-0 transition-transform">
            <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6 md:hidden"></div>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold">Atur Sesi</h3>
                    <p id="modal-info-slot" class="text-xs text-indigo-400 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-800 rounded-full"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Mata Pelajaran</label>
                    <select id="assign-mapel" class="w-full bg-slate-800 p-4 rounded-2xl border border-slate-700 focus:ring-2 ring-indigo-500 outline-none appearance-none"></select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Guru Pengajar</label>
                    <select id="assign-guru" class="w-full bg-slate-800 p-4 rounded-2xl border border-slate-700 focus:ring-2 ring-indigo-500 outline-none appearance-none"></select>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="saveAssignment()" class="flex-1 bg-indigo-600 py-4 rounded-2xl font-bold hover:scale-[1.02] active:scale-95 transition-all">Simpan Jadwal</button>
                    <button onclick="deleteAssignment()" class="bg-red-500/10 text-red-500 px-6 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ARCHITECTURE STATE ---
        let state = {
            gurus: [],
            mapels: [],
            kelass: [],
            timeSlots: [
                { id: 1, start: '07:30', end: '08:15', isRest: false },
                { id: 2, start: '08:15', end: '09:00', isRest: false },
                { id: 3, start: '09:00', end: '09:15', isRest: true },
                { id: 4, start: '09:15', end: '10:00', isRest: false }
            ],
            schedules: {},
            days: ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'],
            activeDay: 'Senin',
            isMobile: window.innerWidth < 768
        };

        let currentActiveSlot = null;

        window.onload = () => {
            const saved = localStorage.getItem('ultra_scheduler_v2');
            if(saved) state = { ...state, ...JSON.parse(saved) };
            
            window.addEventListener('resize', () => {
                state.isMobile = window.innerWidth < 768;
                renderScheduleGrid();
            });

            initLucide();
            renderAll();
        };

        function saveState() {
            localStorage.setItem('ultra_scheduler_v2', JSON.stringify(state));
        }

        function initLucide() { lucide.createIcons(); }

        // --- RENDER ENGINES ---
        function renderAll() {
            renderDayNav();
            renderGuruList();
            renderMapelList();
            renderKelasList();
            renderKelasDropdown();
            renderScheduleGrid();
        }

        function renderDayNav() {
            const nav = document.getElementById('mobile-day-nav');
            nav.innerHTML = state.days.map(d => `
                <button onclick="setActiveDay('${d}')" class="px-6 py-3 text-sm font-bold whitespace-nowrap transition-all ${state.activeDay === d ? 'tab-active' : 'text-slate-500'}">
                    ${d}
                </button>
            `).join('');
        }

        function setActiveDay(day) {
            state.activeDay = day;
            renderDayNav();
            renderScheduleGrid();
        }

        function renderScheduleGrid() {
            const container = document.getElementById('schedule-container');
            const activeKelasId = document.getElementById('select-kelas-active').value;
            
            if(!activeKelasId) {
                container.innerHTML = `<div class="p-12 text-center text-slate-500 border-2 border-dashed border-slate-800 rounded-3xl">Pilih atau buat kelas terlebih dahulu di tab 'Daftar Kelas'</div>`;
                return;
            }

            if(state.isMobile) {
                // Tampilan Mobile: Vertical List per Hari
                container.innerHTML = state.timeSlots.map(slot => {
                    if(slot.isRest) return `<div class="p-3 bg-slate-800/30 text-center text-xs font-bold text-slate-500 rounded-xl">ISTIRAHAT (${slot.start} - ${slot.end})</div>`;
                    
                    const data = state.schedules[activeKelasId]?.[`${state.activeDay}-${slot.id}`];
                    const mapel = state.mapels.find(m => m.id === data?.mapelId);
                    const guru = state.gurus.find(g => g.id === data?.guruId);
                    const isConflict = checkConflict(activeKelasId, state.activeDay, slot.id);

                    return `
                        <div onclick="openAssignModal('${state.activeDay}', ${slot.id})" class="flex items-center gap-4 glass p-4 rounded-2xl active:scale-95 transition-transform">
                            <div class="w-16 shrink-0 text-center border-r border-slate-700 pr-4">
                                <div class="text-sm font-bold text-indigo-400">${slot.start}</div>
                                <div class="text-[10px] text-slate-500">${slot.end}</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                ${data ? `
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full" style="background: ${mapel?.color}"></div>
                                        <h4 class="font-bold text-sm truncate text-white">${mapel?.nama}</h4>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ${guru?.nama} (${guru?.inisial})</p>
                                    ${isConflict ? `<span class="text-[10px] text-red-500 font-bold flex items-center gap-1 mt-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Konflik Jadwal Guru!</span>` : ''}
                                ` : `<span class="text-slate-600 text-sm font-medium">Kosong - Tap untuk isi</span>`}
                            </div>
                            <i data-lucide="chevron-right" class="text-slate-700 w-5 h-5"></i>
                        </div>
                    `;
                }).join('');
            } else {
                // Tampilan Desktop: Matriks Grid
                let html = `<div class="grid grid-cols-7 gap-3">
                    <div class="p-4 text-center font-bold text-slate-500 text-xs uppercase tracking-widest">Waktu</div>
                    ${state.days.map(d => `<div class="p-4 text-center font-bold text-indigo-400 text-xs uppercase tracking-widest">${d}</div>`).join('')}`;
                
                state.timeSlots.forEach(slot => {
                    html += `<div class="p-4 glass rounded-xl flex flex-col justify-center items-center">
                        <span class="font-bold text-sm">${slot.start}</span>
                        <span class="text-[10px] text-slate-500">${slot.end}</span>
                    </div>`;

                    state.days.forEach(day => {
                        const data = state.schedules[activeKelasId]?.[`${day}-${slot.id}`];
                        const mapel = state.mapels.find(m => m.id === data?.mapelId);
                        const isConflict = checkConflict(activeKelasId, day, slot.id);

                        if(slot.isRest) {
                            html += `<div class="bg-slate-800/20 rounded-xl flex items-center justify-center text-[10px] font-bold text-slate-600">REST</div>`;
                        } else if(data) {
                            html += `<div onclick="openAssignModal('${day}', ${slot.id})" class="p-3 rounded-xl cursor-pointer hover:scale-105 transition-all relative overflow-hidden group border-2" style="border-color: ${mapel?.color}44; background: ${mapel?.color}11">
                                <div class="font-bold text-[11px] text-white truncate">${mapel?.nama}</div>
                                <div class="text-[9px] text-slate-400 mt-1 uppercase">${state.gurus.find(g => g.id === data.guruId)?.inisial}</div>
                                ${isConflict ? `<div class="absolute top-1 right-1 text-red-500"><i data-lucide="alert-triangle" class="w-3 h-3"></i></div>` : ''}
                            </div>`;
                        } else {
                            html += `<div onclick="openAssignModal('${day}', ${slot.id})" class="border-2 border-dashed border-slate-800 rounded-xl hover:border-indigo-500/50 cursor-pointer flex items-center justify-center transition-all">
                                <i data-lucide="plus" class="w-4 h-4 text-slate-700 group-hover:text-indigo-500"></i>
                            </div>`;
                        }
                    });
                });
                html += `</div>`;
                container.innerHTML = html;
            }
            initLucide();
        }

        // --- LOGIC FUNCTIONS (Integrity) ---
        function checkConflict(kelasId, day, slotId) {
            const current = state.schedules[kelasId]?.[`${day}-${slotId}`];
            if(!current) return false;
            return Object.keys(state.schedules).some(kId => {
                if(kId === kelasId) return false;
                const target = state.schedules[kId][`${day}-${slotId}`];
                return target && target.guruId === current.guruId;
            });
        }

        function addGuru() {
            const nama = document.getElementById('input-guru-nama').value;
            const inisial = document.getElementById('input-guru-inisial').value.toUpperCase();
            if(!nama || !inisial) return;
            state.gurus.push({ id: 'G-'+Date.now(), nama, inisial });
            saveState(); renderAll();
            document.getElementById('input-guru-nama').value = '';
            document.getElementById('input-guru-inisial').value = '';
        }

        function addMapel() {
            const nama = document.getElementById('input-mapel-nama').value;
            const color = document.getElementById('input-mapel-color').value;
            if(!nama) return;
            state.mapels.push({ id: 'M-'+Date.now(), nama, color });
            saveState(); renderAll();
            document.getElementById('input-mapel-nama').value = '';
        }

        function addKelas() {
            const nama = document.getElementById('input-kelas-nama').value;
            if(!nama) return;
            state.kelass.push({ id: 'K-'+Date.now(), nama });
            saveState(); renderAll();
            document.getElementById('input-kelas-nama').value = '';
        }

        function changeActiveKelas() {
            const val = document.getElementById('select-kelas-active').value;
            const kelas = state.kelass.find(k => k.id === val);
            document.getElementById('mobile-class-indicator').innerText = kelas?.nama || 'Pilih Kelas';
            renderScheduleGrid();
        }

        // --- UI UTILS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-indigo-600'));
            event.currentTarget.classList.add('bg-indigo-600');
            if(state.isMobile) toggleSidebar();
        }

        function openAssignModal(day, slotId) {
            const kelasId = document.getElementById('select-kelas-active').value;
            currentActiveSlot = { day, slotId, kelasId };
            const slot = state.timeSlots.find(s => s.id === slotId);
            document.getElementById('modal-info-slot').innerText = `${day.toUpperCase()} | ${slot.start} - ${slot.end}`;
            
            const mSel = document.getElementById('assign-mapel');
            mSel.innerHTML = state.mapels.map(m => `<option value="${m.id}">${m.nama}</option>`).join('') || '<option value="">Buat Mapel Dulu</option>';
            
            const gSel = document.getElementById('assign-guru');
            gSel.innerHTML = state.gurus.map(g => `<option value="${g.id}">${g.nama} (${g.inisial})</option>`).join('') || '<option value="">Buat Data Guru Dulu</option>';

            const existing = state.schedules[kelasId]?.[`${day}-${slotId}`];
            if(existing) { mSel.value = existing.mapelId; gSel.value = existing.guruId; }

            const modal = document.getElementById('modal-assign');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() { document.getElementById('modal-assign').classList.add('hidden'); }

        function saveAssignment() {
            const { kelasId, day, slotId } = currentActiveSlot;
            const mId = document.getElementById('assign-mapel').value;
            const gId = document.getElementById('assign-guru').value;
            if(!mId || !gId) return alert('Lengkapi data mapel/guru!');
            
            if(!state.schedules[kelasId]) state.schedules[kelasId] = {};
            state.schedules[kelasId][`${day}-${slotId}`] = { mapelId: mId, guruId: gId };
            saveState(); closeModal(); renderScheduleGrid();
        }

        function deleteAssignment() {
            const { kelasId, day, slotId } = currentActiveSlot;
            delete state.schedules[kelasId][`${day}-${slotId}`];
            saveState(); closeModal(); renderScheduleGrid();
        }

        function renderGuruList() {
            const cont = document.getElementById('list-guru');
            cont.innerHTML = state.gurus.map(g => `<div class="p-4 glass rounded-xl flex justify-between items-center">
                <div><p class="font-bold text-sm">${g.nama}</p><p class="text-xs text-indigo-400 font-bold">${g.inisial}</p></div>
                <button onclick="deleteItem('gurus', '${g.id}')" class="text-slate-600 hover:text-red-400"><i data-lucide="trash"></i></button>
            </div>`).join('');
            initLucide();
        }

        function renderMapelList() {
            const cont = document.getElementById('list-mapel');
            cont.innerHTML = state.mapels.map(m => `<div class="p-4 glass rounded-xl flex justify-between items-center border-l-4" style="border-left-color: ${m.color}">
                <p class="font-bold text-sm">${m.nama}</p>
                <button onclick="deleteItem('mapels', '${m.id}')" class="text-slate-600 hover:text-red-400"><i data-lucide="trash"></i></button>
            </div>`).join('');
            initLucide();
        }

        function renderKelasList() {
            const cont = document.getElementById('list-kelas');
            cont.innerHTML = state.kelass.map(k => `<div class="p-4 glass rounded-xl flex flex-col items-center gap-2">
                <p class="font-bold text-sm">${k.nama}</p>
                <button onclick="deleteItem('kelass', '${k.id}')" class="text-xs text-red-400 hover:underline">Hapus</button>
            </div>`).join('');
            initLucide();
        }

        function renderKelasDropdown() {
            const sel = document.getElementById('select-kelas-active');
            sel.innerHTML = state.kelass.map(k => `<option value="${k.id}">${k.nama}</option>`).join('') || '<option value="">Buat Kelas</option>';
        }

        function deleteItem(type, id) {
            state[type] = state[type].filter(x => x.id !== id);
            saveState(); renderAll();
        }

        function exportPDF() { alert('Fitur Export PDF sedang menyiapkan data...'); /* Menggunakan logika jspdf-autotable yang sama */ }
        function exportExcel() { alert('Mengekspor data ke format .xlsx...'); }
    </script>
</body>
</html>
